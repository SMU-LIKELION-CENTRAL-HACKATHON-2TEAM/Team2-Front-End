<!doctype html>
<meta charset="utf-8" />
<title>Kakao Map – 사이드바만 스크롤 + 고정 헤더/푸터 + 디테일 팝업</title>

<style>
    :root {
        --list-width: 40vh;
        --detail-width: 40vh;
        --gutter: 18px;
        --detail-minvh: 100;
        --panel-alpha: .95;
        --panel-blur: 8px;
        --radius: 14px;
        --blue: #1e88f7;
        --text-muted: #6b7280;
    }

    * {
        box-sizing: border-box
    }

    html,
    body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif
    }

    body {
        overflow: hidden
    }

    /* 레이아웃 */
    .app {
        height: 100vh;
        display: grid;
        grid-template-columns: var(--list-width) 1fr;
        position: relative
    }

    .app>.side,
    .app>#map {
        min-height: 0
    }

    /* 사이드바(스크롤 영역+고정 푸터) */
    .side {
        display: grid;
        grid-template-rows: 1fr auto;
        border-right: 1px solid #eee;
        background: #fff;
        overflow: hidden;
        z-index: 1
    }

    .side-scroll {
        min-height: 0;
        overflow: auto
    }

    .side-head {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #fff;
        padding: 14px 14px 10px;
        border-bottom: 1px solid #eef2f6
    }

    .side-body {
        padding: 10px 14px 0 14px
    }

    .side-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-top: 1px solid #eee;
        background: #fff
    }

    .pill {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #dde3ea;
        border-radius: 999px;
        padding: 6px
    }

    /* 아이콘 버튼들 */
    .btn-circle {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 0;
        display: grid;
        place-items: center;
        background: #cfd6df;
        cursor: pointer
    }

    .btn-circle img {
        width: 22px;
        height: 22px;
        display: block
    }

    .btn-circle.primary {
        background: var(--blue);
        color: #fff
    }

    .btn-circle.bookmark-on {
        background: #ffd54f
    }

    /* 요청하신 “아이콘 뒤 진한 회색 원 제거” */
    #btnBookmark {
        background: transparent;
        border: 0
    }

    #btnBookmark img {
        opacity: .7
    }

    #btnSettings {
        background: transparent;
        border: 0;
        border-radius: 10px
    }

    #btnSettings img {
        width: 22px;
        height: 22px;
        opacity: .7
    }

    /* 지도 */
    #map {
        grid-column: 2;
        width: 100%;
        height: 100%
    }

    /* 검색 인풋 – 항상 파란 테두리 */
    .search-with-icon {
        position: relative
    }

    .search-with-icon input {
        width: 100%;
        height: 6vh;
        padding: 0 44px 0 14px;
        font-size: 24px;
        font-weight: 700;
        background: #fff;
        -webkit-appearance: none;
        appearance: none;
        border: 3px solid #2A83D7;
        border-radius: 8px;
        box-shadow: none;
        outline: none;
    }

    .search-with-icon input:focus {
        border-color: #2A83D7;
        box-shadow: 0 0 0 3px rgba(42, 131, 215, .18)
    }

    .search-with-icon input::placeholder {
        color: #cbd5e1;
        font-weight: 600
    }

    .search-with-icon .search-icon {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        width: 28px;
        height: 28px;
        border: 0;
        background: transparent;
        display: grid;
        place-items: center;
        cursor: pointer
    }

    .search-with-icon .search-icon .icon-img {
        width: 20px;
        height: 20px;
        display: block
    }

    /* 결과 카드 */
    .muted {
        color: var(--text-muted);
        font-size: 12px
    }

    .list {
        display: grid;
        gap: 10px
    }

    .result-card {
        border: 1px solid #e5e7eb;
        border-radius: var(--radius);
        padding: 12px 14px 14px;
        background: #fff;
        display: grid;
        gap: 10px;
        transition: border-color .15s, background .15s, box-shadow .15s;
        cursor: pointer
    }

    .result-card:hover {
        background: #f0f7ff;
        border-color: #cfe3ff;
        box-shadow: 0 1px 0 rgba(16, 24, 40, .04)
    }

    /* 썸네일 + 스켈레톤 */
    .thumb {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 12px;
        background: #e9edf2;
        overflow: hidden
    }

    .thumb.sk::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, .7) 50%, rgba(255, 255, 255, 0) 100%);
        animation: shimmer 1.2s infinite;
    }

    @keyframes shimmer {
        100% {
            transform: translateX(100%)
        }
    }

    .thumb-img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none
    }

    .thumb.has-img .thumb-img {
        display: block
    }

    .title {
        font-weight: 600;
        font-size: 20px;
        line-height: 1.2
    }

    .open-txt {
        margin-left: 8px;
        font-weight: 500;
        font-size: 12px;
        color: #88D649
    }

    .meta {
        display: flex;
        align-items: center;
        gap: 8px
    }

    .meta .sub {
        flex: 1;
        color: #A6AAB4;
        font-weight: 500;
        font-size: 16px;
        line-height: 1.4
    }

    .chev {
        flex: 0 0 auto;
        width: 40px;
        height: 28px;
        display: grid;
        place-items: center
    }

    .chev img {
        width: 12px;
        height: 12px;
        display: block
    }

    .aid-line {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        color: #2A83D7;
        font-size: 16px
    }

    .aid-line::before {
        content: "ⓘ";
        color: #60a5fa
    }

    /* 디테일 팝업(오버레이) */
    .detail-pop {
        position: fixed;
        top: 12px;
        left: calc(var(--list-width) + var(--gutter));
        width: var(--detail-width);
        min-height: min(calc(var(--detail-minvh)*1vh), calc(100vh - 24px));
        max-height: calc(100vh - 24px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: rgba(255, 255, 255, var(--panel-alpha));
        backdrop-filter: saturate(1.05) blur(var(--panel-blur));
        border: 1px solid rgba(255, 255, 255, .65);
        border-radius: 14px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, .14);
        z-index: 5;
        opacity: 0;
        pointer-events: none;
        transform: translateY(8px);
        transition: opacity .2s ease, transform .2s ease;
    }

    .app.details-open .detail-pop {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0)
    }

    .detail-header {
        position: sticky;
        top: 0;
        z-index: 1;
        background: transparent;
        padding: 10px 12px 8px;
        border-bottom: 1px solid rgba(240, 240, 240, .9);
        display: grid;
        grid-template-columns: 36px 1fr;
        align-items: center;
        gap: 8px
    }

    .icon-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #fff;
        cursor: pointer
    }

    #detailBody {
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding: 12px 14px
    }
</style>

<div class="app" id="app">
    <!-- 왼쪽: 사이드바 -->
    <aside class="side">
        <div class="side-scroll" id="sideScroll">
            <div class="side-head">
                <form id="searchForm" class="search-with-icon">
                    <input id="query" placeholder="text" autocomplete="off" />
                    <button type="submit" class="search-icon" aria-label="검색">
                        <img src="/images/findIcon.svg" alt="" aria-hidden="true" class="icon-img">
                    </button>
                </form>
                <div id="resultMeta" class="muted" style="margin-top:10px">검색 결과가 여기에 표시됩니다.</div>
            </div>
            <div class="side-body">
                <div id="results" class="list"></div>
            </div>
        </div>

        <div class="side-footer">
            <div class="pill">
                <button class="btn-circle primary" id="btnSearch" title="검색">
                    <img src="/images/findIcon.svg" alt="">
                </button>
                <button class="btn-circle" id="btnBookmark" title="북마크 토글">
                    <img src="/images/bookMark.svg" alt="">
                </button>
            </div>
            <button class="btn-gear" id="btnSettings" title="설정">
                <img src="/images/settingIcon.svg" alt="">
            </button>
        </div>
    </aside>

    <!-- 오른쪽: 지도 -->
    <div id="map"></div>

    <!-- 디테일 팝업 -->
    <aside class="detail-pop" id="detailPanel" aria-live="polite">
        <div class="detail-header">
            <button class="icon-btn" id="detailBack" title="닫기">←</button>
            <div>
                <div class="h" id="detailTitle" style="margin:0">Location Name</div>
                <div class="muted" id="detailAddr">주소가 여기에 표시됩니다</div>
            </div>
        </div>
        <div id="detailBody" class="list"></div>
    </aside>
</div>

<!-- Kakao Maps SDK -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6738c70e17749fde58007eca30b8f1ba&libraries=services"></script>
<script>
    (() => {
        const appEl = document.getElementById('app');
        const resultsEl = document.getElementById('results');
        const resultMeta = document.getElementById('resultMeta');
        const queryEl = document.getElementById('query');
        const sideScroll = document.getElementById('sideScroll');

        const btnSearch = document.getElementById('btnSearch');
        const btnBookmark = document.getElementById('btnBookmark');
        const btnBack = document.getElementById('detailBack');
        const detailTitle = document.getElementById('detailTitle');
        const detailAddr = document.getElementById('detailAddr');

        const map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.9780), level: 7
        });
        const places = new kakao.maps.services.Places();
        const markers = [];

        /* ---------- thumbnail helpers (서버리스 사용) ---------- */
        async function getOgImage(targetUrl) {
            try {
                const res = await fetch(`/api/og?url=${encodeURIComponent(targetUrl)}`);
                if (!res.ok) return null;
                const data = await res.json();
                return data && data.image ? data.image : null;
            } catch (e) {
                return null;
            }
        }
        function proxiedImg(src) { return `/api/img?url=${encodeURIComponent(src)}`; }

        /* ---------- UI helpers ---------- */
        function clearResults() {
            markers.forEach(m => m.setMap(null));
            markers.length = 0;
            resultsEl.innerHTML = '';
        }
        function fitBounds(positions) {
            if (!positions.length) return;
            const b = new kakao.maps.LatLngBounds();
            positions.forEach(p => b.extend(p));
            map.setBounds(b);
        }
        function openDetail(place, pos) {
            logPlaceJSON(place); // ← 클릭 시 콘솔에 JSON 출력

            detailTitle.textContent = place.place_name || 'Location Name';
            detailAddr.textContent = place.road_address_name || place.address_name || '';
            appEl.classList.add('details-open');
            if (pos) map.panTo(pos);
            setTimeout(() => btnBack.focus(), 0);
        }


        // 콘솔에 보기 좋은 JSON 포맷으로 출력
        function logPlaceJSON(p) {
            // 필요한 항목만 뽑아 숫자는 숫자로 변환
            const obj = {
                id: p.id,
                place_name: p.place_name,
                category_name: p.category_name,
                phone: p.phone,
                address_name: p.address_name,
                road_address_name: p.road_address_name,
                x: Number(p.x),
                y: Number(p.y),
                place_url: p.place_url,
                distance: p.distance ? Number(p.distance) : undefined,
            };

            console.log("▶ raw place object", p);                       // SDK 원본 객체
            console.log("▶ place JSON object", obj);                    // 정리된 객체
            console.log("▶ place JSON string\n" + JSON.stringify(obj, null, 2)); // 문자열
        }


        function closeDetail() { appEl.classList.remove('details-open'); }

        /* ---------- 카드 생성 (지연 로딩으로 썸네일 주입) ---------- */
        const io = new IntersectionObserver((entries) => {
            entries.forEach(async (en) => {
                if (!en.isIntersecting) return;
                const card = en.target;
                io.unobserve(card);

                const targetUrl = card.dataset.placeUrl;
                if (!targetUrl) return;

                // OG 이미지 가져오기 → 프록시를 통해 <img>에 세팅
                const og = await getOgImage(targetUrl);
                if (og) {
                    const thumb = card.querySelector('.thumb');
                    const img = card.querySelector('.thumb-img');
                    img.src = proxiedImg(og);
                    img.onload = () => thumb.classList.add('has-img');
                }
            });
        }, { root: sideScroll, threshold: 0.1 });

        function createCard(p, pos) {
            const cat = (p.category_name || '').split('>').pop()?.trim() || 'Category';
            const addr = p.road_address_name || p.address_name || '';

            const card = document.createElement('div');
            card.className = 'result-card';
            card.dataset.placeUrl = p.place_url || ''; // ← 서버리스가 이 URL에서 og:image 추출
            card.innerHTML = `
      <div class="thumb sk">
        <img class="thumb-img" alt="">
      </div>
      <div class="title">${p.place_name}<span class="open-txt">Open</span></div>
      <div class="meta">
        <div class="sub">${cat} – ${addr}</div>
        <div class="chev" aria-hidden="true">
          <img src="/images/greyRightBtn.svg" alt="">
        </div>
      </div>
      <div class="aid-line">AI description</div>
    `;
            card.addEventListener('click', () => openDetail(p, pos));

            // 썸네일은 사이드 스크롤에 보일 때 로드
            io.observe(card);
            return card;
        }

        /* ---------- 검색 ---------- */
        function doSearch(q) {
            if (!q || !q.trim()) return;
            clearResults();
            resultMeta.textContent = '검색 중…';

            const positions = [];
            let total = 0;
            const frag = document.createDocumentFragment();

            const handle = (data, status, pagination) => {
                if (status !== kakao.maps.services.Status.OK) {
                    if (total === 0) resultMeta.textContent = '검색 결과가 없습니다.';
                    return;
                }

                data.forEach(p => {
                    total++;
                    const pos = new kakao.maps.LatLng(p.y, p.x);
                    positions.push(pos);

                    const marker = new kakao.maps.Marker({ position: pos, map, zIndex: 1 });
                    markers.push(marker);
                    kakao.maps.event.addListener(marker, 'click', () => openDetail(p, pos));

                    frag.appendChild(createCard(p, pos));
                });

                resultsEl.appendChild(frag);
                resultMeta.textContent = `${total}개 로딩 중…`;

                const hasNext = pagination && (
                    (pagination.hasNextPage && typeof pagination.nextPage === 'function') ||
                    (pagination.current && pagination.last && pagination.current < pagination.last && typeof pagination.gotoPage === 'function')
                );
                if (hasNext) {
                    if (typeof pagination.nextPage === 'function') pagination.nextPage();
                    else pagination.gotoPage(pagination.current + 1);
                    return;
                }

                resultMeta.textContent = `${total}개의 검색 결과`;
                fitBounds(positions);
            };

            places.keywordSearch(q, handle, { location: map.getCenter(), page: 1 });
        }

        /* ---------- Events ---------- */
        document.getElementById('searchForm').addEventListener('submit', (e) => { e.preventDefault(); doSearch(queryEl.value); });
        btnSearch.addEventListener('click', () => doSearch(queryEl.value));
        btnBookmark.addEventListener('click', () => btnBookmark.classList.toggle('bookmark-on'));
        btnBack.addEventListener('click', closeDetail);

        /* 초기 검색 */
        doSearch('김치');
    })();
</script>